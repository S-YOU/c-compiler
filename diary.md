# C(のサブセット)コンパイラ開発日記

## 2018年7月8日

- VirtualBoxにUbuntuを入れるのに失敗した。しかたがないのでmacOSで開発する。まあ関数呼び出しとか実装するようになるのはもっと後の話だろうし。

- 課題1（標準入力で数値を受け取り、その数値をreturnする関数のコードを吐く）。やるだけ。入力に乱数を入れたくて、ググったとおりに適当にやったが、なんか上手く行かなかった。macOSのbashの仕様が違うのかもしれないし、私がbashを理解していないのかもしれない。両方か。

- `+` と `-` だけがあるlexerを実装。

- 課題2。とりあえずCPUをスタックマシンにするために頑張ろう。[Compiler Explorer](https://godbolt.org/)のコードを見て、見よう見まねでpushとか演算とかが実装できるようになった。チラ見した他の人のコードには普通に `push` みたいなニーモニックが書いてあったが、まあとりあえず動けばよかろうなのだ。

- lexerとスタックマシンができたのだから、あとは中置をRPNにするだけ。再帰下降パーサーを書けばいいのだが、何を思ったかshunting-yardを実装（しかもまだvectorが無いので有限長の配列）。どうせどこかで挫折するんだろうなぁ

- 無事動いた。やったぜ。

- vectorが欲しいけど、つらくかなしい `void*` よりはメタプログラミングの方がまだマシでは。

- vectorを無事shunting-yardに組み込むことに成功。これにて今日は終わり。

## 2018年7月9日

- 8日の日記を書いた後に、コードをきれいにして、さらに掛け算を実装。

- 用事とか誕生日とかがあったのでそんなに組めていない。まあ今日はこんなもんでいいや。

- 新機能としては、掛け算が増え、一般に複数の優先順位にだいたい対応できたということぐらいである。どちらかというとコード美化をした一日だった。

## 2018年7月10日

- まったりしていたので進捗なし。たまにはこういう日もある。

## 2018年7月11日

- まったりしていたらみなさんがとても進捗を出しているの図。

- とりあえず、パーサー拡充して演算子だけでも処理するか。演算子は大量にあるけれど代入とかを除けばだいたい同じだし。

- 除算・剰余・カンマを実装。じゃあ次は比較演算子を実装して2文字の演算子について考えることとするか

- 比較演算子( `< <= > >= == !=` ) と ビット演算子( `& | << >>` ) を実装する途中で、スペースも処理するようにした。

- 単項演算子( `! ~` )を実装したところで、そろそろ変数とかの方に移っていこうか。

## 2018年7月12日

### 連想配列の実装
- 寝て起きたので日が変わっている。えーと連想配列組まなきゃなんだよな。

- `(char *, int)`というペアの配列で実装しろとのことなので、vectorテンプレートを使う。オレオレテンプレート、やはり便利。

- 実装できたと思う。テストも書いた。

### ローカル変数の実装
- ローカル変数を処理できるようにしよう。%rbpはローカル変数の処理に使うべきで、固定しておくべきっぽいので、いままで%rbpを上下させて実装していたスタックマシンを、%rspを上下させるような仕様に変更。

- 領域を確保するコードを正しく実装できた。さて次はlexerを変数に対応させよう。

- 変数に対応させようとしたら、なんか16進数と8進数が実装されていた。変数に対応させよう。

- とりあえずパーサーが変数を読めるようにした。

### リポジトリ美化

- テストファイルの命名に一貫性がないこと、自動生成されている`.s`が.gitignoreされていないことに関して指摘を受けたので訂正。

### ローカル変数の実装

- さてさて。ローカル変数の実装だ。そろそろshunting-yardだと支障をきたし始める頃だろうか。知らんけど。

## 2018年7月13日

### ローカル変数の実装

- アセンブリを書いてみたところ、まあ当然右辺値として使うかどうかによって文脈判断が要るので、再帰下降にするしかないことが確定。まあそれはそうだった。最初から再帰下降にしておけばよかったのに。

### リポジトリ美化part2

- 空白はトークンではないのでlexerから削除。

- ヘッダファイルを合流させた。

- テストをまとめたり減らしたりした。
	* 出力ファイルにデバッグ情報を埋め込むことで、わざわざテストをしなくてもデバッグしやすいようになった。
	* `--lexer-debug` オプションを実装することで、わざわざテストをしなくてもデバッグしやすいようになった。
	* それによって不要になったテストを削除。`print_assembly_check009` はcheckではなくsandboxなので、そう改名。

- clang-formatを使用。

- 再帰下降で全部書き直すことに成功。

- 再帰下降にしたので単項`+`と単項`-`が実装できるように。よって実装。

- 複文を実装。「最後の評価値を戻り値にする」をそのままやるのが面倒だったため、`return`も追加した。`return`の後に更に文が来たときの挙動は現状では未定義とする（実情としては、「評価されるが」返り値には影響を与えない、みたいな挙動になるはず）
